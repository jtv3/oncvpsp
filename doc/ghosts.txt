                               FIXING GHOSTS

  New computational experiments point to an underlying cause of many,
if not all ghosts.  When an eigenvalue of the B matrix, Eq.(21) of the
included Phys. Rev. B paper, is close to zero, very large coefficients can
be carried through transformation to the orthonormal projectors, Eq.(24) and
produce deeply-bound ghost states.  A well-tested and benchmarked psp can
be close to having such a zero, and an inconsequential change such as
running data developed for releases 2.1.1 - 3.2.3 on 3.3.1 could push the
eigenvalue enough towards that zero to make a ghost.  Changing to another exc
functional could do the same.

  The recommended fix is a small change in the local potential, which in
principal should have no effect on the quality of the psp.  Assuming the
recommended option lloc=4, used in the several published oncpsp tabulations,
the correct parameter to vary is dvloc0.  This adds a compatible polynomial
to the extrapolation of the all-electron potential to the origin, shifting
its origin value by the specified amount.  This change can be incremental,
whereas changing lpopt produces a shape change, and changing rc(5) steps
among log mesh points.  dvloc0 shifts as small as +/- 0.5 or even 0.25 Ha
can eliminate a ghost.  Tuning through the zero eigenvalue can change a
deeply-bound ghost to a high-lying ghost resonance, which is probably
harmless.

  A "pre-alpha-release" option can be activated to explore the vicinity of
a ghost systematically.  Uncommenting lines 470-476 of oncvpsp.f90 and
line 132 of run_vkb.f90 will sweep dvloc0 by +/- 1 Ha around the input value 
in small steps and write file fort.20 with lines labeled by angular momenta 
(0L, 1L, etc.) with the shifted dvloc0 values and the B matrix eigenvalues.
These can be extracted and graphed for each L, indicating values far enough
away from the zero for a reported ghost while making sure that possible zeros
for other Ls are avoided.  This feature might be incorporated into the
built-in graphics in a future release, and extended along with the new ghost
tests described below to relativistic calculations.

  This approach is not recommended when developing a new potential with a
different choice of valence electrons, different rcs, etc.  It's better to
have it ghost-free without this adjustment.

                    GHOST STATES, RESONANCES, and DETECTION

  Bound states of the radial Schroedinger equation with a local potential are
strictly ordered in energy by their number of nodes.  This is not necessarily
true for separable non-local pseudopotentials.  Spurious bound states with
more nodes can arise below or between the zero- and one-node states which the
projectors are designed to reproduce.  While in the case of single Kleinman-
Bylander projectors, a simple test can predict their presence from the bound 
states of the local potential and the non-local projector coefficient,
( X. Gonze, P. K ̈ackell, and M. Scheffler, Phys. Rev. B 41, 12264
(1990)), no such test exists for multiple-projector potentials.

  Until release 3.3.0, ghosts were to be identified in oncvpsp by examining
the Arctan(log derivative) (hence ALD) plots generated by the code and the
run.sh scripts.  Steps or near-steps of -Pi in the ALDs could indicate a
tightly-bound real state, in which case they would be present and should
nearly overlap in both the pseudopotential and all-electron ALDs.  When the 
PS ALD had such a step where the AE ALD was flat, that was a ghost, typically
below the lowest desired nodeless pseudo-valence state for that L, with 
several nodes, and with most of its amplitude overlapping the non-local
projectors inside rc.  While routine ALD plots over energies extending
moderately beyond the expected range of the bands of interest would reveal
these, potentials including shallow cores or 4f electrons could produce
deeply-bound ghosts that would not be discovered until the potentials were
used in an application.  They could typically lead to bizarre results
in ground-state calculations.

  A corresponding problem was positive-energy ghosts, spurious highly-
localized scattering resonances of the PSP which would lead to spurious
flat conduction bands.  These would usually be seen in the routine ALD plots, 
and could be ignored if they were above the bands of interest, unlike the
negative-energy ghosts.


  A new "ghost detector" has been introduced in 3.3.0 and extended in 3.3.1.
It is described below and in the src/run_ghosts.f90 comments.  The ALD
plotting routines run_pshft*.f90 have been modified to compute the ALD just
outside rc. In most cases, scans for the ALD drop near where the new ghost
detector reports one show the drop   However, if a coresponding -Pi drop
isn't seen, trust the ghost detector.  The code reports the "Pseudoatom
total energy," and if the  energy of a simple monatomic solid run with
your code is an unreasonable amount lower than that, trust the ghost
detector.  To understand why the ALD may miss the ghost, see the comments
and code in vkbphsft.f90 line 161 and following.  This has been a tough
issue to deal with.

  Two new tests for ghosts:  The local potential is terminated by a hard wall
barrier at a radius of mbfact*rc, presently 3*rc.  A basis set is formed
by solving the radial Schroedinger equation for eigenstates this combination
at a given L and used to compute a Hamiltonian matrix.  The  off-diagonal 
terms come exclusively from the non-local projectors.  A cutoff is chosen to
simulate a reasonably well converged plane-wave calculation.  The Hamiltonian
is diagonalized, and the results used as follows:
 
  Test 1) Negative eigenvalues are compared with those of the radial
Schroedinger equation for the full-range non-local pseudopotential.  Those 
lying below the Schroedinger Eq. results and which presumably have more nodes
are reported and tagged as GHOST(-) in the *.out file.
 
  Test 2) For barrier states with  positive eigenvalues, the average radius
is computed.  Such states could be ghost resonances, and highly localized
ones with <r>/rc<1 are reported as GHOST(+).  Real fairly localized
resonances can occur, particularly at lower energies, and the GHOST(+)
report is an indication that the  ALD plot should be examined carefully 
around the reported energy to see if the all-electron plot has a corresponding
drop of Pi.

  These test  results are illustrated in the tests/refs/*.out files.  A deep
f ghost is reported in 60_Nd_GHOST.out.

 Testing for bound ghosts
   n   l    E NL Schr. Eq   E Basis Diag.   E Cutoff

       3                     -207.919149     43.01  WARNING - GHOST(-)

  This absurdly low energy ghost was actually reported by a user.  It can
be eliminated by substituting the presently commented-out line under
# LOCAL POTENTIAl for the active line in the input data file.  The
dvloc0 value used was chosen after examining plots from the "pre-alpha-
release" option described in FIXING GHOSTS above.

  Several positive-energy ghosts reports are also found:

       Testing for highly-localized positive-energy ghosts
             l    <radius>/rc     E Basis Diag.   E Cutoff

07_N.out:    0        0.857439       23.267510     31.16  WARNING - GHOST(+)
32_Ge.out:   0        0.983569        3.888608     12.99  WARNING - GHOST(+)
56_Ba.out:   0        0.937972        4.762306     13.58  WARNING - GHOST(+)
56_Ba.out:   3        0.761397        0.058838     49.98  WARNING - GHOST(+)
57_La.out:   0        0.701020        3.701594     13.60  WARNING - GHOST(+)
60_Nd_G*:    0        0.798928        7.192549     19.57  WARNING - GHOST(+)
83_Bi.out:   0        0.830838        3.877424      9.72  WARNING - GHOST(+)

The positive-energy ghosts for Ge (s), Ba (s), La (s), and Bi (s) are seen
in the ALD plots and are real ghosts, indicated by the spurious Pi steps
near the reported energies.  The Ba (f) reported ghost(+) near zero energy,
however, is a legitimate resonance indicated by the overlapping smoothed
steps in the PS and AE ALDs.  The N (s) and Nd (s) ghosts are beyond the
plots, and probably too high in energy to be of concern.

  The new tests should only be considered "beta" until users have more 
experience with them.  They have not yet (as of 3.3.1) been implemented for
relativistic calculations, but a scalar-relativistic calculation with the 
same input should be a reasonably reliable test.

  The 14_Si_GHOST.dat of past releases had a very unrealistic local potential
and has been dropped.
